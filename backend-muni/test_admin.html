<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin - Sistema Municipal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        input, select, textarea { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .response { margin-top: 10px; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .form-group { margin: 10px 0; }
        .form-group label { display: inline-block; width: 120px; font-weight: bold; }
        .users-list, .roles-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        .user-item, .role-item { padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Admin - Sistema de Expedientes Municipales</h1>
        <p><strong>Panel de administraci√≥n para probar funcionalidades de gesti√≥n de usuarios, roles y permisos</strong></p>

        <!-- AUTENTICACI√ìN -->
        <div class="section">
            <h3>üîë Autenticaci√≥n</h3>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" value="admin@municipalidad.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" value="admin123">
            </div>
            <button onclick="login()">üîê Login Admin</button>
            <button onclick="getAuthUser()">üë§ Ver Usuario Actual</button>
            <button onclick="logout()" class="danger">üö™ Logout</button>
            <div id="authResponse" class="response" style="display:none;"></div>
        </div>

        <!-- GESTI√ìN DE USUARIOS -->
        <div class="section">
            <h3>üë• Gesti√≥n de Usuarios</h3>
            
            <div style="display: flex; gap: 20px;">
                <!-- Lista de usuarios -->
                <div style="flex: 1;">
                    <h4>Lista de Usuarios</h4>
                    <button onclick="listarUsuarios()">üìã Listar Usuarios</button>
                    <div id="usersList" class="users-list"></div>
                </div>

                <!-- Crear usuario -->
                <div style="flex: 1;">
                    <h4>Crear Nuevo Usuario</h4>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="userName" placeholder="Juan P√©rez">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="userEmail" placeholder="juan@municipalidad.com">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="userPassword" placeholder="password123">
                    </div>
                    <div class="form-group">
                        <label>Gerencia:</label>
                        <select id="userGerencia">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rol:</label>
                        <select id="userRole">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <button onclick="crearUsuario()" class="success">‚ûï Crear Usuario</button>
                </div>
            </div>
            <div id="usersResponse" class="response" style="display:none;"></div>
        </div>

        <!-- GESTI√ìN DE ROLES -->
        <div class="section">
            <h3>üé≠ Gesti√≥n de Roles</h3>
            
            <div style="display: flex; gap: 20px;">
                <!-- Lista de roles -->
                <div style="flex: 1;">
                    <h4>Roles Existentes</h4>
                    <button onclick="listarRoles()">üìã Listar Roles</button>
                    <div id="rolesList" class="roles-list"></div>
                </div>

                <!-- Crear rol -->
                <div style="flex: 1;">
                    <h4>Crear Nuevo Rol</h4>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="roleName" placeholder="nuevo_rol">
                    </div>
                    <div class="form-group">
                        <label>Guard:</label>
                        <select id="roleGuard">
                            <option value="web">web</option>
                            <option value="api">api</option>
                        </select>
                    </div>
                    <button onclick="crearRol()" class="success">‚ûï Crear Rol</button>
                </div>
            </div>
            <div id="rolesResponse" class="response" style="display:none;"></div>
        </div>

        <!-- GESTI√ìN DE PERMISOS -->
        <div class="section">
            <h3>üîê Gesti√≥n de Permisos</h3>
            
            <div style="display: flex; gap: 20px;">
                <!-- Lista de permisos -->
                <div style="flex: 1;">
                    <h4>Permisos Existentes</h4>
                    <button onclick="listarPermisos()">üìã Listar Permisos</button>
                    <div id="permissionsList" class="roles-list"></div>
                </div>

                <!-- Crear permiso -->
                <div style="flex: 1;">
                    <h4>Crear Nuevo Permiso</h4>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="permissionName" placeholder="nuevo_permiso">
                    </div>
                    <div class="form-group">
                        <label>Guard:</label>
                        <select id="permissionGuard">
                            <option value="web">web</option>
                            <option value="api">api</option>
                        </select>
                    </div>
                    <button onclick="crearPermiso()" class="success">‚ûï Crear Permiso</button>
                </div>
            </div>
            <div id="permissionsResponse" class="response" style="display:none;"></div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div class="section">
            <h3>üìä Estad√≠sticas del Sistema</h3>
            <button onclick="getEstadisticas()">üìà Ver Estad√≠sticas</button>
            <div id="statsResponse" class="response" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('admin_token') || '';

        // Headers para requests autenticados
        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
        }

        // Mostrar respuesta en div espec√≠fico
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.innerHTML = JSON.stringify(data, null, 2);
        }

        // ===================================================================
        // AUTENTICACI√ìN
        // ===================================================================

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.data.token;
                    localStorage.setItem('admin_token', authToken);
                    showResponse('authResponse', data);
                    // Cargar datos iniciales
                    cargarGerencias();
                    cargarRoles();
                } else {
                    showResponse('authResponse', data, true);
                }
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        async function getAuthUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/user`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                showResponse('authResponse', data, !data.success);
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                authToken = '';
                localStorage.removeItem('admin_token');
                showResponse('authResponse', { message: 'Logout exitoso' });
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        // ===================================================================
        // GESTI√ìN DE USUARIOS
        // ===================================================================

        async function listarUsuarios() {
            try {
                const response = await fetch(`${API_BASE}/usuarios`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = data.data.data.map(user => `
                        <div class="user-item">
                            <div>
                                <strong>${user.name}</strong><br>
                                <small>${user.email} - ${user.gerencia?.nombre || 'Sin gerencia'}</small><br>
                                <small>Roles: ${user.roles.map(r => r.name).join(', ')}</small>
                            </div>
                            <div>
                                <button onclick="eliminarUsuario(${user.id})" class="danger">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                    showResponse('usersResponse', { message: `${data.data.data.length} usuarios encontrados` });
                } else {
                    showResponse('usersResponse', data, true);
                }
            } catch (error) {
                showResponse('usersResponse', { error: error.message }, true);
            }
        }

        async function crearUsuario() {
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                gerencia_id: document.getElementById('userGerencia').value || null,
                roles: document.getElementById('userRole').value ? [document.getElementById('userRole').value] : [],
                activo: true
            };

            try {
                const response = await fetch(`${API_BASE}/usuarios`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                showResponse('usersResponse', data, !data.success);
                
                if (data.success) {
                    // Limpiar formulario
                    document.getElementById('userName').value = '';
                    document.getElementById('userEmail').value = '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userGerencia').value = '';
                    document.getElementById('userRole').value = '';
                    // Recargar lista
                    listarUsuarios();
                }
            } catch (error) {
                showResponse('usersResponse', { error: error.message }, true);
            }
        }

        async function eliminarUsuario(userId) {
            if (!confirm('¬øEst√° seguro de eliminar este usuario?')) return;

            try {
                const response = await fetch(`${API_BASE}/usuarios/${userId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                showResponse('usersResponse', data, !data.success);
                
                if (data.success) {
                    listarUsuarios();
                }
            } catch (error) {
                showResponse('usersResponse', { error: error.message }, true);
            }
        }

        // ===================================================================
        // GESTI√ìN DE ROLES
        // ===================================================================

        async function listarRoles() {
            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const rolesList = document.getElementById('rolesList');
                    rolesList.innerHTML = data.data.map(role => `
                        <div class="role-item">
                            <div>
                                <strong>${role.name}</strong><br>
                                <small>Guard: ${role.guard_name}</small><br>
                                <small>Permisos: ${role.permissions.length}</small>
                            </div>
                            <div>
                                <button onclick="eliminarRol(${role.id})" class="danger">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                    showResponse('rolesResponse', { message: `${data.data.length} roles encontrados` });
                } else {
                    showResponse('rolesResponse', data, true);
                }
            } catch (error) {
                showResponse('rolesResponse', { error: error.message }, true);
            }
        }

        async function crearRol() {
            const roleData = {
                name: document.getElementById('roleName').value,
                guard_name: document.getElementById('roleGuard').value
            };

            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(roleData)
                });
                
                const data = await response.json();
                showResponse('rolesResponse', data, !data.success);
                
                if (data.success) {
                    document.getElementById('roleName').value = '';
                    listarRoles();
                    cargarRoles(); // Recargar select
                }
            } catch (error) {
                showResponse('rolesResponse', { error: error.message }, true);
            }
        }

        async function eliminarRol(roleId) {
            if (!confirm('¬øEst√° seguro de eliminar este rol?')) return;

            try {
                const response = await fetch(`${API_BASE}/roles/${roleId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                showResponse('rolesResponse', data, !data.success);
                
                if (data.success) {
                    listarRoles();
                    cargarRoles();
                }
            } catch (error) {
                showResponse('rolesResponse', { error: error.message }, true);
            }
        }

        // ===================================================================
        // GESTI√ìN DE PERMISOS
        // ===================================================================

        async function listarPermisos() {
            try {
                const response = await fetch(`${API_BASE}/permissions`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const permissionsList = document.getElementById('permissionsList');
                    let html = '';
                    Object.keys(data.data).forEach(guard => {
                        html += `<h5>${guard.toUpperCase()}</h5>`;
                        data.data[guard].forEach(permission => {
                            html += `
                                <div class="role-item">
                                    <div>
                                        <strong>${permission.name}</strong>
                                    </div>
                                    <div>
                                        <button onclick="eliminarPermiso(${permission.id})" class="danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        });
                    });
                    permissionsList.innerHTML = html;
                    showResponse('permissionsResponse', { message: 'Permisos cargados' });
                } else {
                    showResponse('permissionsResponse', data, true);
                }
            } catch (error) {
                showResponse('permissionsResponse', { error: error.message }, true);
            }
        }

        async function crearPermiso() {
            const permissionData = {
                name: document.getElementById('permissionName').value,
                guard_name: document.getElementById('permissionGuard').value
            };

            try {
                const response = await fetch(`${API_BASE}/permissions`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(permissionData)
                });
                
                const data = await response.json();
                showResponse('permissionsResponse', data, !data.success);
                
                if (data.success) {
                    document.getElementById('permissionName').value = '';
                    listarPermisos();
                }
            } catch (error) {
                showResponse('permissionsResponse', { error: error.message }, true);
            }
        }

        async function eliminarPermiso(permissionId) {
            if (!confirm('¬øEst√° seguro de eliminar este permiso?')) return;

            try {
                const response = await fetch(`${API_BASE}/permissions/${permissionId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                showResponse('permissionsResponse', data, !data.success);
                
                if (data.success) {
                    listarPermisos();
                }
            } catch (error) {
                showResponse('permissionsResponse', { error: error.message }, true);
            }
        }

        // ===================================================================
        // ESTAD√çSTICAS
        // ===================================================================

        async function getEstadisticas() {
            try {
                const response = await fetch(`${API_BASE}/admin/roles-permissions/stats`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                showResponse('statsResponse', data, !data.success);
            } catch (error) {
                showResponse('statsResponse', { error: error.message }, true);
            }
        }

        // ===================================================================
        // FUNCIONES AUXILIARES
        // ===================================================================

        async function cargarGerencias() {
            try {
                const response = await fetch(`${API_BASE}/gerencias`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('userGerencia');
                    select.innerHTML = '<option value="">Seleccionar...</option>';
                    data.data.forEach(gerencia => {
                        select.innerHTML += `<option value="${gerencia.id}">${gerencia.nombre}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error cargando gerencias:', error);
            }
        }

        async function cargarRoles() {
            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('userRole');
                    select.innerHTML = '<option value="">Seleccionar...</option>';
                    data.data.forEach(role => {
                        select.innerHTML += `<option value="${role.name}">${role.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error cargando roles:', error);
            }
        }

        // Cargar token al inicio si existe
        if (authToken) {
            document.getElementById('authResponse').style.display = 'block';
            document.getElementById('authResponse').className = 'response info';
            document.getElementById('authResponse').innerHTML = 'Token encontrado en localStorage';
            cargarGerencias();
            cargarRoles();
        }
    </script>
</body>
</html>